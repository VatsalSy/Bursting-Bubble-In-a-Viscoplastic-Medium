<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
            <title> - two-phaseVP.h</title>
        <link href="http://basilisk.fr/css/custom.css" rel="stylesheet" media="screen, projection" type="text/css" />
    <link href="http://basilisk.fr/css/print.css" rel="stylesheet" media="print" type= "text/css" />
        <!--[if IE]><link href="http://basilisk.fr/css/ie.css" rel="stylesheet" media="screen, projection" type="text/css" /><![endif]-->
    <link rel="stylesheet" href="http://basilisk.fr/css/basilisk.css"/>
    <script src="http://basilisk.fr/js/jquery.min.js" type="text/javascript"></script>
    <script src="http://basilisk.fr/js/jquery-ui.packed.js" type="text/javascript"></script>
    <script src="http://basilisk.fr/js/plots.js" type="text/javascript"></script>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
      integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j"
      crossorigin="anonymous"/>
<script defer
	src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"
	integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ"
	crossorigin="anonymous">
</script>
  </head>
  <body>
    <div id="doc3" class="yui-t1">
        <div id="yui-main">
          <div id="maincol" class="yui-b">
<div id="userbox">
  <noscript>
    <a href="http://basilisk.fr/_login">Login</a>
    <a href="http://basilisk.fr/_logout">Logout</a>
  </noscript>
  &nbsp;
  <a id="loginlink" class="login" href="http://basilisk.fr/_login">Login / Get an account</a>
  <a id="logoutlink" class="login" href="http://basilisk.fr/_logout">Logout <span id="logged_in_user"></span></a>
</div>
<ul class="tabs">
  <li class=selected><a href="http://basilisk.fr/two-phaseVP.h">view</a></li><li><a href="http://basilisk.fr/two-phaseVP.h?history">history</a></li>
</ul>
<div id="content">
        <h1 class="pageTitle"><a href="http://basilisk.fr/two-phaseVP.h">two-phaseVP.h</a></h1>
  <ul class="messages" id="messages"></ul>
  <div id="status"></div>
    <div id="TOC">
<ul>
<li><a href="#two-phase-interfacial-flows">Two-phase interfacial flows</a></li>
</ul>
</div>
<h1 id="two-phase-interfacial-flows">Two-phase interfacial flows</h1>
<p>This is a modified version of <a href="http://basilisk.fr/src/two-phase.h">two-phase.h</a>. It contains the implementation of Viscoplastic Fluid (Bingham Fluid).<br/> This file helps setup simulations for flows of two fluids separated by an interface (i.e. immiscible fluids). It is typically used in combination with a <a href="navier-stokes/centered.h">Navier–Stokes solver</a>.</p>
<p>The interface between the fluids is tracked with a Volume-Of-Fluid method. The volume fraction in fluid 1 is <span class="math inline">f=1</span> and <span class="math inline">f=0</span> in fluid 2. The densities and dynamic viscosities for fluid 1 and 2 are <em>rho1</em>, <em>mu1</em>, <em>rho2</em>, <em>mu2</em>, respectively.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&quot;<a href=http://basilisk.fr/src/vof.h>vof.h</a>&quot;</span><span class="pp"><span id=14></span></span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span id=15></span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="dt">scalar</span> f[], * interfaces = {f};<span id=16></span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="dt">scalar</span> D2[];<span id=17></span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><a href=http://basilisk.fr/Basilisk%20C#face-and-vertex-fields>face</a> <span class="dt">vector</span> D2f[];<span id=18></span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="dt">double</span> rho1 = <span class="fl">1.</span>, mu1 = <span class="fl">0.</span>, rho2 = <span class="fl">1.</span>, mu2 = <span class="fl">0.</span>;<span id=19></span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="dt">double</span> mumax = <span class="fl">0.</span>, tauy = <span class="fl">0.</span>;<span id=20></span></span></code></pre></div>
<p>Auxilliary fields are necessary to define the (variable) specific volume <span class="math inline">\alpha=1/\rho</span> as well as the cell-centered density.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><a href=http://basilisk.fr/Basilisk%20C#face-and-vertex-fields>face</a> <span class="dt">vector</span> alphav[];<span id=25></span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="dt">scalar</span> rhov[];<span id=26></span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span id=27></span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><a href=http://basilisk.fr/Basilisk%20C#events>event</a> <a id=defaults>defaults</a> (i = <span class="dv">0</span>) {<span id=28></span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>  alpha = alphav;<span id=29></span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  rho = rhov;<span id=30></span><span id=31></span></span></code></pre></div>
<p>If the viscosity is non-zero, we need to allocate the face-centered viscosity field.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>  <span class="cf">if</span> (mu1 || mu2)<span id=36></span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>    mu = new <a href=http://basilisk.fr/Basilisk%20C#face-and-vertex-fields>face</a> <span class="dt">vector</span>;<span id=37></span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>}<span id=38></span><span id=39></span></span></code></pre></div>
<p>The density and viscosity are defined using arithmetic averages by default. The user can overload these definitions to use other types of averages (i.e. harmonic).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="pp">#ifndef rho<span id=45></span></span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="pp"># define rho(f) (clamp(f,0.,1.)*(rho1 - rho2) + rho2)<span id=46></span></span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="pp">#endif<span id=47></span></span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="pp">#ifndef mu<span id=48></span></span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="pp"># define mu(muTemp, mu2, f)  (clamp(f,0.,1.)*(muTemp - mu2) + mu2)<span id=49></span></span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="pp">#endif<span id=50></span><span id=51></span></span></span></code></pre></div>
<p>We have the option of using some “smearing” of the density/viscosity jump.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="pp">#ifdef FILTERED<span id=56></span></span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="dt">scalar</span> sf[];<span id=57></span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="pp">#else<span id=58></span></span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="pp"># define sf f<span id=59></span></span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="pp">#endif<span id=60></span></span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a><span id=61></span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><a href=http://basilisk.fr/Basilisk%20C#events>event</a> <a id=properties>properties</a> (i++) {<span id=62></span><span id=63></span></span></code></pre></div>
<p>When using smearing of the density jump, we initialise <em>sf</em> with the vertex-average of <em>f</em>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="pp">#ifndef sf<span id=68></span></span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="pp">#if dimension &lt;= 2<span id=69></span></span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#iterators>foreach</a>()<span id=70></span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    sf[] = (<span class="fl">4.</span>*f[] +<span id=71></span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>	    <span class="fl">2.</span>*(f[<span class="dv">0</span>,<span class="dv">1</span>] + f[<span class="dv">0</span>,-<span class="dv">1</span>] + f[<span class="dv">1</span>,<span class="dv">0</span>] + f[-<span class="dv">1</span>,<span class="dv">0</span>]) +<span id=72></span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>	    f[-<span class="dv">1</span>,-<span class="dv">1</span>] + f[<span class="dv">1</span>,-<span class="dv">1</span>] + f[<span class="dv">1</span>,<span class="dv">1</span>] + f[-<span class="dv">1</span>,<span class="dv">1</span>])/<span class="fl">16.</span>;<span id=73></span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="pp">#else </span><span class="co">// dimension == 3<span id=74></span></span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#iterators>foreach</a>()<span id=75></span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    sf[] = (<span class="fl">8.</span>*f[] +<span id=76></span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>	    <span class="fl">4.</span>*(f[-<span class="dv">1</span>] + f[<span class="dv">1</span>] + f[<span class="dv">0</span>,<span class="dv">1</span>] + f[<span class="dv">0</span>,-<span class="dv">1</span>] + f[<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>] + f[<span class="dv">0</span>,<span class="dv">0</span>,-<span class="dv">1</span>]) +<span id=77></span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>	    <span class="fl">2.</span>*(f[-<span class="dv">1</span>,<span class="dv">1</span>] + f[-<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>] + f[-<span class="dv">1</span>,<span class="dv">0</span>,-<span class="dv">1</span>] + f[-<span class="dv">1</span>,-<span class="dv">1</span>] +<span id=78></span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>		f[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>] + f[<span class="dv">0</span>,<span class="dv">1</span>,-<span class="dv">1</span>] + f[<span class="dv">0</span>,-<span class="dv">1</span>,<span class="dv">1</span>] + f[<span class="dv">0</span>,-<span class="dv">1</span>,-<span class="dv">1</span>] +<span id=79></span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>		f[<span class="dv">1</span>,<span class="dv">1</span>] + f[<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>] + f[<span class="dv">1</span>,-<span class="dv">1</span>] + f[<span class="dv">1</span>,<span class="dv">0</span>,-<span class="dv">1</span>]) +<span id=80></span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>	    f[<span class="dv">1</span>,-<span class="dv">1</span>,<span class="dv">1</span>] + f[-<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>] + f[-<span class="dv">1</span>,<span class="dv">1</span>,-<span class="dv">1</span>] + f[<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>] +<span id=81></span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>	    f[<span class="dv">1</span>,<span class="dv">1</span>,-<span class="dv">1</span>] + f[-<span class="dv">1</span>,-<span class="dv">1</span>,-<span class="dv">1</span>] + f[<span class="dv">1</span>,-<span class="dv">1</span>,-<span class="dv">1</span>] + f[-<span class="dv">1</span>,-<span class="dv">1</span>,<span class="dv">1</span>])/<span class="fl">64.</span>;<span id=82></span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="pp">#endif<span id=83></span></span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a><span class="pp">#endif<span id=84></span></span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a><span id=85></span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a><span class="pp">#if TREE<span id=86></span></span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a>  sf.prolongation = refine_bilinear;<span id=87></span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#boundary-conditions>boundary</a> ({sf});<span id=88></span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a><span class="pp">#endif<span id=89></span><span id=90></span></span></span></code></pre></div>
<p>This is part where we have made changes. <span class="math display">\mathcal{D}_{11} = \frac{\partial u_r}{\partial r}</span></p>
<p><span class="math display">\mathcal{D}_{22} = \frac{u_r}{r}</span></p>
<p><span class="math display">\mathcal{D}_{13} = \frac{1}{2}\left( \frac{\partial u_r}{\partial z}+ \frac{\partial u_z}{\partial r}\right)</span></p>
<p><span class="math display">\mathcal{D}_{31} = \frac{1}{2}\left( \frac{\partial u_z}{\partial r}+ \frac{\partial u_r}{\partial z}\right)</span></p>
<p><span class="math display">\mathcal{D}_{33} = \frac{\partial u_z}{\partial z}</span></p>
<p><span class="math display">\mathcal{D}_{12} = \mathcal{D}_{23} = 0.</span></p>
<p>The second invariant is <span class="math inline">\mathcal{D}_2=\sqrt{\mathcal{D}_{ij}\mathcal{D}_{ij}}</span> (this is the Frobenius norm) <span class="math display">\mathcal{D}_2^2= \mathcal{D}_{ij}\mathcal{D}_{ij}= \mathcal{D}_{11}\mathcal{D}_{11} + \mathcal{D}_{22}\mathcal{D}_{22} + \mathcal{D}_{13}\mathcal{D}_{31} + \mathcal{D}_{31}\mathcal{D}_{13} + \mathcal{D}_{33}\mathcal{D}_{33}</span></p>
<p><strong>Note:</strong> <span class="math inline">\|\mathcal{D}\| = D_2/\sqrt{2}</span>.<br/></p>
<p>We use the formulation as given in <a href="https://www.annualreviews.org/doi/pdf/10.1146/annurev-fluid-010313-141424">Balmforth et al. (2013)</a>, they use <span class="math inline">\dot \gamma</span> which is by their definition <span class="math inline">\sqrt{\frac{1}{2}\dot \gamma_{ij} \dot \gamma_{ij}}</span> and as <span class="math inline">\dot \gamma_{ij}=2 D_{ij}</span></p>
<p>Therefore, <span class="math inline">\dot \gamma</span> = <span class="math inline">\sqrt{2} \mathcal{D}_2</span>, that is why we have a <span class="math inline">\sqrt{2}</span> in the equations.</p>
<p>Factorising with <span class="math inline">2 \mathcal{D}_{ij}</span> to obtain a equivalent viscosity <span class="math display">\tau_{ij} = 2( \mu_0 + \frac{\tau_y}{2 \|\mathcal{D}\| } ) D_{ij}=2( \mu_0 + \frac{\tau_y}{\sqrt{2} \mathcal{D}_2 } ) \mathcal{D}_{ij} </span> As defined by <a href="https://www.annualreviews.org/doi/pdf/10.1146/annurev-fluid-010313-141424">Balmforth et al. (2013)</a> <span class="math display">\tau_{ij} = 2 \mu_{eq}  \mathcal{D}_{ij} </span> with <span class="math display">\mu_{eq}= \mu_0 + \frac{\tau_y}{\sqrt{2} \mathcal{D}_2 }</span></p>
<p>Finally, mu is the min of of <span class="math inline">\mu_{eq}</span> and a large <span class="math inline">\mu_{max}</span>.</p>
<p>The fluid flows always, it is not a solid, but a very viscous fluid. <span class="math display"> \mu = \text{min}\left(\mu_{eq}, \mu_{max}\right) </span></p>
<p>Reproduced from: <a href="http://basilisk.fr/sandbox/M1EMN/Exemples/bingham_simple.c">P.-Y. Lagrée’s Sandbox</a>. Here, we use a face implementation of the regularisation method, described <a href="http://basilisk.fr/sandbox/vatsal/GenaralizedNewtonian/Couette_NonNewtonian.c">here</a>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#foreach_face>foreach_face</a>(x) {<span id=132></span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="dt">double</span> ff = (sf[] + sf[-<span class="dv">1</span>])/<span class="fl">2.</span>;<span id=133></span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>    alphav.x[] = fm.x[]/rho(ff);<span id=134></span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    <span class="dt">double</span> muTemp = mu1;<span id=135></span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>    <a href=http://basilisk.fr/Basilisk%20C#face-and-vertex-fields>face</a> <span class="dt">vector</span> muv = mu;<span id=136></span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>    <span class="dt">double</span> D11 = <span class="fl">0.5</span>*( (u.y[<span class="dv">0</span>,<span class="dv">1</span>] - u.y[<span class="dv">0</span>,-<span class="dv">1</span>] + u.y[-<span class="dv">1</span>,<span class="dv">1</span>] - u.y[-<span class="dv">1</span>,-<span class="dv">1</span>])/(<span class="fl">2.</span>*Delta) );<span id=137></span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>    <span class="dt">double</span> D22 = (u.y[] + u.y[-<span class="dv">1</span>, <span class="dv">0</span>])/(<span class="dv">2</span>*max(y, <span class="fl">1e-20</span>));<span id=138></span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    <span class="dt">double</span> D33 = (u.x[] - u.x[-<span class="dv">1</span>,<span class="dv">0</span>])/Delta;<span id=139></span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    <span class="dt">double</span> D13 = <span class="fl">0.5</span>*( (u.y[] - u.y[-<span class="dv">1</span>, <span class="dv">0</span>])/Delta + <span class="fl">0.5</span>*( (u.x[<span class="dv">0</span>,<span class="dv">1</span>] - u.x[<span class="dv">0</span>,-<span class="dv">1</span>] + u.x[-<span class="dv">1</span>,<span class="dv">1</span>] - u.x[-<span class="dv">1</span>,-<span class="dv">1</span>])/(<span class="fl">2.</span>*Delta) ) );<span id=140></span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a><span id=141></span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>    <span class="dt">double</span> D2temp = sqrt( sq(D11) + sq(D22) + sq(D33) + <span class="dv">2</span>*sq(D13) );<span id=142></span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a>    <span class="cf">if</span> (D2temp &gt; <span class="fl">0.</span> &amp;&amp; tauy &gt; <span class="fl">0.</span>){<span id=143></span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a>      <span class="dt">double</span> temp = tauy/(sqrt(<span class="fl">2.</span>)*D2temp) + mu1;<span id=144></span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a>      muTemp = min(temp, mumax);<span id=145></span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>    } <span class="cf">else</span> {<span id=146></span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a>      <span class="cf">if</span> (tauy &gt; <span class="fl">0.</span>){<span id=147></span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a>        muTemp = mumax;<span id=148></span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a>      } <span class="cf">else</span> {<span id=149></span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a>        muTemp = mu1;<span id=150></span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a>      }<span id=151></span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a>    }<span id=152></span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a>    muv.x[] = fm.x[]*mu(muTemp, mu2, ff);<span id=153></span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a>    D2f.x[] = D2temp;<span id=154></span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a>  }<span id=155></span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a><span id=156></span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#foreach_face>foreach_face</a>(y) {<span id=157></span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true"></a>    <span class="dt">double</span> ff = (sf[<span class="dv">0</span>,<span class="dv">0</span>] + sf[<span class="dv">0</span>,-<span class="dv">1</span>])/<span class="fl">2.</span>;<span id=158></span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true"></a>    alphav.y[] = fm.y[]/rho(ff);<span id=159></span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true"></a>    <span class="dt">double</span> muTemp = mu1;<span id=160></span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true"></a>    <a href=http://basilisk.fr/Basilisk%20C#face-and-vertex-fields>face</a> <span class="dt">vector</span> muv = mu;<span id=161></span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true"></a>    <span class="dt">double</span> D11 = (u.y[<span class="dv">0</span>,<span class="dv">0</span>] - u.y[<span class="dv">0</span>,-<span class="dv">1</span>])/Delta;<span id=162></span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true"></a>    <span class="dt">double</span> D22 = (u.y[<span class="dv">0</span>,<span class="dv">0</span>] + u.y[<span class="dv">0</span>,-<span class="dv">1</span>])/(<span class="dv">2</span>*max(y, <span class="fl">1e-20</span>));<span id=163></span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true"></a>    <span class="dt">double</span> D33 = <span class="fl">0.5</span>*( (u.x[<span class="dv">1</span>,<span class="dv">0</span>] - u.x[-<span class="dv">1</span>,<span class="dv">0</span>] + u.x[<span class="dv">1</span>,-<span class="dv">1</span>] - u.x[-<span class="dv">1</span>,-<span class="dv">1</span>])/(<span class="fl">2.</span>*Delta) );<span id=164></span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true"></a>    <span class="dt">double</span> D13 = <span class="fl">0.5</span>*( (u.x[<span class="dv">0</span>,<span class="dv">0</span>] - u.x[<span class="dv">0</span>,-<span class="dv">1</span>])/Delta + <span class="fl">0.5</span>*( (u.y[<span class="dv">1</span>,<span class="dv">0</span>] - u.y[-<span class="dv">1</span>,<span class="dv">0</span>] + u.y[<span class="dv">1</span>,-<span class="dv">1</span>] - u.y[-<span class="dv">1</span>,-<span class="dv">1</span>])/(<span class="fl">2.</span>*Delta) ) );<span id=165></span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true"></a><span id=166></span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true"></a>    <span class="dt">double</span> D2temp = sqrt( sq(D11) + sq(D22) + sq(D33) + <span class="dv">2</span>*sq(D13) );<span id=167></span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true"></a>    <span class="cf">if</span> (D2temp &gt; <span class="fl">0.</span> &amp;&amp; tauy &gt; <span class="fl">0.</span>){<span id=168></span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true"></a>      <span class="dt">double</span> temp = tauy/(sqrt(<span class="fl">2.</span>)*D2temp) + mu1;<span id=169></span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true"></a>      muTemp = min(temp, mumax);<span id=170></span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true"></a>    } <span class="cf">else</span> {<span id=171></span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true"></a>      <span class="cf">if</span> (tauy &gt; <span class="fl">0.</span>){<span id=172></span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true"></a>        muTemp = mumax;<span id=173></span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true"></a>      } <span class="cf">else</span> {<span id=174></span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true"></a>        muTemp = mu1;<span id=175></span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true"></a>      }<span id=176></span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true"></a>    }<span id=177></span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true"></a>    muv.y[] = fm.y[]*mu(muTemp, mu2, ff);<span id=178></span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true"></a>    D2f.y[] = D2temp;<span id=179></span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true"></a>  }<span id=180></span></span></code></pre></div>
<p>I also calculate a cell-centered <span class="dt">scalar</span> D2, where I store <span class="math inline">\|\mathbf{\mathcal{D}}\|</span>. This can also be used for refimnement to accurately refine the fake-yield surfaces.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#iterators>foreach</a>(){<span id=184></span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    rhov[] = cm[]*rho(sf[]);<span id=185></span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>    D2[] = (D2f.x[]+D2f.y[]+D2f.x[<span class="dv">1</span>,<span class="dv">0</span>]+D2f.y[<span class="dv">0</span>,<span class="dv">1</span>])/<span class="fl">4.</span>;<span id=186></span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    <span class="cf">if</span> (D2[] &gt; <span class="fl">0.</span>){<span id=187></span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>      D2[] = log(D2[])/log(<span class="dv">10</span>);<span id=188></span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    } <span class="cf">else</span> {<span id=189></span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>      D2[] = -<span class="dv">10</span>;<span id=190></span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>    }<span id=191></span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>  }<span id=192></span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#boundary-conditions>boundary</a>(all);<span id=193></span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a><span class="pp">#if TREE<span id=194></span></span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>  sf.prolongation = fraction_refine;<span id=195></span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>  <a href=http://basilisk.fr/Basilisk%20C#boundary-conditions>boundary</a> ({sf});<span id=196></span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a><span class="pp">#endif<span id=197></span></span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a>}<span id=198></span></span></code></pre></div>
</div>
<div id="footer">
inspired by <a href="http://github.com/jgm/gitit/tree/master/">gitit</a>,
powered by <a href="http://basilisk.fr/src/darcsit/README">darcsit</a>
</div>
          </div>
        </div>
        <div id="sidebar" class="yui-b first">
<div id="logo">
  <a href="http://basilisk.fr/" alt="site logo" title="Go to top page"><img src="http://basilisk.fr/img/logo.png" /></a>
</div>
          <div class="sitenav">
  <fieldset>
    <legend>Site</legend>
    <ul>
      <li><a href="http://basilisk.fr/Front Page">Front page</a></li>
      <li><a href="http://basilisk.fr/_index">All pages</a></li>
      <li><a href="http://basilisk.fr/_activity">Recent activity</a></li>
            <li><a href="http://basilisk.fr/Help">Help</a></li>
    </ul>
    <form action="/_search" method="get" id="searchform">
      <input type="text" name="patterns" id="patterns"/>
      <input type="submit" value="Search"/>
    </form>
  </fieldset>
  <fieldset>
    <legend>Documentation</legend>
    <ul>
      <li><a href="http://basilisk.fr/Tutorial">Tutorial</a></li>
      <li><a href="http://basilisk.fr/src/INSTALL">Installation</a></li>
      <li><a href="http://basilisk.fr/Basilisk C">Basilisk C</a></li>
      <li><a href="http://basilisk.fr/src/README">Solvers and functions</a></li>
      <li><a href="http://basilisk.fr/src/examples/README">Examples</a></li>
      <li><a href="http://groups.google.com/d/forum/basilisk-fr">User forum</a></li>
      <li><a href="http://basilisk.fr/sandbox/documentation">More documentation</a></li>
    </ul>
  </fieldset>
  <fieldset>
    <legend>Development</legend>
    <ul>
      <li><a href="http://basilisk.fr/src/?history">Recent activity</a></li>
      <li><a href="http://basilisk.fr/src/">Source code</a></li>
      <li><a href="https://hub.darcs.net/basilisk/basilisk/browse/src">Darcs Hub</a></li>
      <li><a href="http://basilisk.fr/src/test/README">Test cases</a></li>
      <li><a href="http://basilisk.fr/sandbox/bugs/README">Bug reports</a></li>
      <li><a href="http://basilisk.fr/src/Contributing">How to contribute</a></li>
      <li><a href="http://basilisk.fr/sandbox/">Play in the sandbox</a></li>
    </ul>
  </fieldset>
</div>
                    <div class="pageTools">
  <fieldset>
    <legend>This page</legend>
    <ul>
      <li><a href="http://basilisk.fr/two-phaseVP.h?raw">Raw page source</a></li>
      <li><a href="http://basilisk.fr/two-phaseVP.h?delete">Delete this page</a></li>
    </ul>
  </fieldset>
</div>
                            </div>
    </div>
    
      </body>
</html>
